properties:


  - name: bitmap_bin
    type: AllegroFlare::BitmapBin*
    init_with: nullptr
    constructor_arg: true

  - name: tile_atlas
    type: Tileo::Atlas*
    init_with: nullptr
    constructor_arg: true

  - name: filename
    type: std::string
    init_with: '"filename-not-set.tmj"'
    constructor_arg: true

  - name: bitmap_atlas_filename
    type: std::string
    init_with: '"tiles_dungeon_v1.1.png"'
    constructor_arg: true


functions:


  - name: create_mesh
    type: Tileo::Mesh*
    guards: [ bitmap_bin, tile_atlas ]
    body: |
      // 1
      // load and validate the json data to variables
      std::ifstream i(filename);
      nlohmann::json j;
      i >> j;

      int tmx_height = j["height"];// get height
      int tmx_width = j["width"];// get width
      int tmx_tileheight = j["tileheight"]; // get height
      int tmx_tilewidth = j["tilewidth"]; // get width

      // get first j["layers"] that is a ["type"] == "tilelayer"
      bool tilelayer_type_found = false;
      nlohmann::json tilelayer;
      for (auto &layer : j["layers"].items())
      {
         if (layer.value()["type"] == "tilelayer")
         {
            tilelayer = layer.value();
            tilelayer_type_found = true;
            break;
         }
      }
      if (!tilelayer_type_found) throw std::runtime_error("TMJMeshLoader: error: tilelayer type not found.");
      
      int tilelayer_width = tilelayer["width"];
      int tilelayer_height = tilelayer["height"];
      std::vector<int> tiles = tilelayer["data"].get<std::vector<int>>();

      // validate widths and heights match
      if (tilelayer_width != tmx_width)
      {
         throw std::runtime_error("TMJMeshLoader: error: tilelayer width does not match tmx_width.");
      }
      if (tilelayer_height != tmx_height)
      {
         throw std::runtime_error("TMJMeshLoader: error: tilelayer height does not match tmx_height.");
      }
      if (tmx_tileheight != 16 || tmx_tilewidth != 16)
      {
         throw std::runtime_error("TMJMeshLoader: error: tmx tileheight and tilewidth other than 16 not supported.");
      }
      if (tiles.size() != tmx_width * tmx_height)
      {
         throw std::runtime_error("TMJMeshLoader: error: num tiles (in \"data\" field) does not match width*height.");
      }

      // 2
      // create the atlas
      int tile_width = 16;
      int tile_height = 16;

      ALLEGRO_BITMAP *tile_map_bitmap = bitmap_bin->operator[](bitmap_atlas_filename);
      tile_atlas->set_bitmap_filename(bitmap_atlas_filename);

      bool scaled_and_extruded = true;
      if (scaled_and_extruded)
      {
         int scale = 3;
         ALLEGRO_BITMAP *scaled_extruded_tile_map_bitmap =
            TileAtlasBuilder::build_scaled_and_extruded(tile_map_bitmap, scale);
         al_save_bitmap("/Users/markoates/Desktop/whatever.png", scaled_extruded_tile_map_bitmap);
         tile_atlas->duplicate_bitmap_and_load(scaled_extruded_tile_map_bitmap, tile_width*scale, tile_height*scale, 1);
      }
      else
      {
         tile_atlas->duplicate_bitmap_and_load(tile_map_bitmap, tile_width, tile_height);
      }

      // 3
      // create the mesh
      int num_columns = tmx_width;
      int num_rows = tmx_height;
      Tileo::Mesh* mesh = new Tileo::Mesh(tile_atlas, num_columns, num_rows, tile_width, tile_height);
      mesh->initialize();

      // 4
      // fill the data
      for (int y=0; y<num_rows; y++)
      {
         for (int x=0; x<num_columns; x++)
         {
            int tile_id = tiles[y * num_columns + x];
            mesh->set_tile_id(x, y, tile_id-1);
         }
      }

      // 5
      // return the mesh
      return mesh;
    body_dependency_symbols:
      - Tileo::TileAtlasBuilder
      - nlohmann::json
      - ifstream


dependencies:


  - symbol: ifstream
    headers: [ fstream ]
  - symbol: nlohmann::json
    headers: [ lib/nlohmann/json.hpp ]
  - symbol: AllegroFlare::BitmapBin*
    headers: [ AllegroFlare/BitmapBin.hpp ]
  - symbol: Tileo::Atlas*
    headers: [ Tileo/Atlas.hpp ]
  - symbol: Tileo::Mesh*
    headers: [ Tileo/Mesh.hpp ]
  - symbol: Tileo::TileAtlasBuilder
    headers: [ Tileo/TileAtlasBuilder.hpp ]


